# Embedded Sql Reports
[![Build Status](https://circleci.com/gh/alfanse/embers.svg?branch=master)](https://circleci.com/gh/alfanse/embers)
[![Language](http://img.shields.io/badge/language-java-brightgreen.svg)](https://www.java.com/)

A java library that exposes a restful api for the management and consumption of sql reports.

* **embers/admin/** - allows reports to be added, updated or deleted dynamically.
* **embers/query/<query name>** - run the named sql select query and return the result via http - as CSV.
* **embers/cached/<query name>** - fetch a cached result, or run and cache if cache miss.

### Requirements:
Embed embers in a http container that works with `jakarta.ws.rs`.

You'll need to wire it up and give it a servlet:
* A Jetty example: [EmbersJettyServer](embers-acceptance-tests/src/test/java/adf/embers/tools/EmbersJettyServer.java)
* A Spring example: [EmbersSpringConfiguration](embers-spring/src/main/java/adf/embers/examples/spring/EmbersSpringConfiguration.java)

And inject a `javax.sql.DataSource` into `adf.embers.configuration.EmbersRepositoryConfiguration`

The datasource should have access to the 3 tables required by embers, and have read access to the tables the sql reports are to be run against.

Embers Database tables:

* **queries** - Holds details of the queries that `embers/query` can run.
* **queries_statistics** - Audit information about calls made to `embers/query`.
* **query_result_cache** - Caches results for `embers/cache` service to re-use.

Example of DDL for tables: [EmbersDatabase](embers-acceptance-tests/src/main/java/adf/embers/tools/EmbersDatabase.java)

## Build
To run the build, it requires;

~~As of August 2019: java jdk 11+. Compiled source targets java 1.8.~~

As of 2022 January: java jdk 17. Compiled source targets java 17.

```shell
make verify
```

I use a Makefile to document the different command devs / CI use. Help embedded by typing: `make`

The acceptance tests produce html documentation with sequence diagrams, thanks to [Yatspec](https://github.com/nickmcdowall/yatspec).

I've copied it into the `docs/` folder for perusing on github.
* [admin](docs/AdminQueriesTest.html) - Setting up the available sql queries.
* [query](docs/QueryTest.html) - Using an sql report.
* [query statistics](docs/QueryStatisticsTest.html) - Stats on the existing sql queries.
* [cached queries](docs/CachedQueriesTest.html) - Using a cached query result.
* [e2e](docs/PuttingItAllTogetherTest.html) - End 2 end example, maintaining and using an sql query.

## Code Coverage
powered by jacoco plugin, run:
```shell
gradlew clean codeCoverageReport
```
Code coverage reports will be available here: `embers/build/reports/jacoco/index.html` and sum unit and acceptance tests.


## Circleci
Thanks to circleci, you can see the build here: https://app.circleci.com/pipelines/github/alfanse/embers

Configured by: (.circleci/config.yml)[.circleci/config.yml]

You can view the documentation generated by the acceptance tests there as well, look in the `ARTIFACTS` tab of a build.

These links don't live long, but you can try:
* [yatspec/adf/embers/e2e/PuttingItAllTogetherTest.html](https://119-28635373-gh.circle-artifacts.com/0/yatspec/adf/embers/e2e/PuttingItAllTogetherTest.html)
* [jacoco/index.html](https://119-28635373-gh.circle-artifacts.com/0/jacoco/index.html)

# Backlog

?? what would you like to see here ??
javax.ws.rs -> jakarta.ws.rs - DONE.
